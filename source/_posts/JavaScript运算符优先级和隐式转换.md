---

title: JavaScript运算符优先级和隐式转换
date: 2018/12/26 20:40:51 
tags: JavaScript 运算符 优先级 隐式转换

---

昨天圣诞节，本应该是一个开心的日子，但对有些程序猿来说，是非常糟糕的一天。在很多技术开发群里，在技术论坛以及github社区都炸天了。我想说的是，使用开源的人，得有感激之心，但是贡献开源的人更应该要有敬畏之心。我们要感谢每一个开源的人，他们为这个世界贡献了自己的力量，为这个社会提高了效率，而开源的人也应该怀有敬畏之心，尊重每一个使用者，更好地回馈使用者，使用者和开源这相互成就。

好了，话说回来，今天看了一篇文章，其中有一个题目感觉非常有趣，我也给大家送一个彩蛋吧，其中也引发了我对JavaScript运算符和隐式转换的思考了，所以还是坐下来静下心把JavaScript的运算符和隐式转换学习总结了一下，但其中难免会有些错误，不喜勿喷啊！

先贴个彩蛋：

```({}+[])[[~!+[]]*~+[]]+(!(~+[])+{})[--[~+""][+[]]*[~+[]] + ~~!+[]]```

各位童鞋，你算出来了吗？点击后将揭晓答案哦！当然，等不及的童鞋肯定自己在控制台复制粘贴得出结果了吧，呵呵！

<!-- more -->

答案就是：

![](https://i.imgur.com/8IpzJoy.png)

哈哈，是不是被骂了还在问人这段代码是什么意思呢？

我来告诉你：

这段代码为什么会输出sb呢？其实这段代码考的是js的类型转化的一些基本原理。

首先要运用到的第一个知识就是js运算符的优先级，因为这么长一段运算看的人眼花，我们必须得先根据优先级分成n小段，然后再各个击破。

# js运算符的优先级

优先级的排列如下表，优先级从高到低：

![](https://i.imgur.com/b834A7c.jpg)

根据此规则，我们把这一串运算分为以下表达式：

![](https://i.imgur.com/cdDv5jr.png)

其实中括号[]也是一个运算符，用来通过索引访问数组项，另外也可以访问字符串的子字符，有点类似charAt方法，如：'abcd'[1] // 返回'b'。而且中括号的优先级还是最高的哦。

接下来需要运用的就是JavaScript的类型转化知识了，我们先说说什么情况下需要进行类型转化。当操作符两边的操作数类型不一致或者不是基本类型（也叫原始类型）时，需要进行类型转化。

让我们快速的复习一下，在JavaScript中，一共有两种类型的值：原始值(primitives)和对象值(objects)。

原始值有：undefined、null、布尔值(booleans)、数字(numbers)、还有字符串(strings)。

其他的所有值都是对象类型的值，包括数组(arrays)和函数(functions)。

# 类型转化

先按运算符来分一下类：

减号-，乘号*，肯定是进行数学运算，所以操作数需转化为number类型。

加号+，可能是字符串拼接，也可能是数学运算，所以可能会转化为number或string。

一元运算，如+[]，只有一个操作数的，转化为number类型。

下面来看一下转化规则。

## 对于非原始类型的，通过ToPrimitive()将值转换成原始类型

`ToPrimitive(input, PreferredType?)`

可选参数PreferredType是Number或者是String。返回值为任何原始值。

如果PreferredType是Number，执行顺序如下：

1. 如果input为primitive，返回；

2. 如果input为Object。调用obj.valueOf()，如果结果是primitive，返回；

3. 否则，调用obj.toString()，如果结果是primitive，返回；

4. 否则，抛出TypeError。

如果 PreferredType是String，步骤2跟3互换，如果PreferredType没有，Date实例被设置成String，其他都是Number。

## 通过ToNumber()将值转换为数字

通过ToNumber()把值转换成Number，直接看ECMA 9.3的表格：

如果输入的值是一个对象，则会首先会调用ToPrimitive(obj,Number)将该对象转换为原始值，然后在调用ToNumber()将这个原始值转换为数字。

## 通过ToString()将值转换为字符串

通过ToString()把值转化成字符串， 直接看ECMA 9.8的表格

![](https://i.imgur.com/9hKHPCu.jpg)

如果输入的值是一个对象，则会首先会调用ToPrimitive(obj,String)将该对象转换为原始值，然后再调用ToString()将这个原始值转换为字符串.规则就这么多，接下来实践一下，根据我们上面划分出的子表达式，一步一步将这个神奇的代码给执行出来。开工~

先看最简单的子表达式：

`+[]`

只有一个操作数[]，肯定是转化为number了，根据上面的规则2，[]是个数组，object类型，即对象。所以得先调用toPrimitive转化为原始类型，并且PreferredType为number，这个参数表示更“倾向于”转化的类型，这里肯定是number了。然后首先调用数组的valueOf方法，数组调用valueOf会返回自身，

这个时候，我们得到一个空串“”，还没有结束，看上面的规则2描述，继续调用toNumber，转化为number类型，大功告成！子表达式16转化完毕，+[]，最终得到0。

来看子表达式：

`[~+""]`

空串""前面有两个一元操作符，但是操作数还是只有一个，所以，最终要转化为的类型是number。看规则2吧，空串调用toNumber得到0。接下来是~，这是个什么东东呢？它是位运算符，作用可以记为把数字取负然后减一，所以~0就是-1 。

别忘了，这个子表达式外头还包着中括号，所以最终的值为[-1]，即一个数组，里面只有一个元素-1.

接下来看子表达式就简单了

把以上求出来的填进去，就变成了这样：--[-1][0]，取数组的第0个元素，然后自减，结果为-2，是不so easy!

继续往后走，子表达式：

`[~+[]]`

其实把上面的原理用上就非常明显了，答案[-1]。

继续，此刻它已变成：-2*[-1]，有稍许不一样，不过没关系，我们还是按照规则来，运算符是乘号*，当然是做数学运算，那后面的[-1]就得转化为number，过程如下：

1. 调用toPrimitive，发现是object类型

2. 调用valueOf，返回自身[-1]

3. 因为不是原始类型，继续调用toString，返回"-1"

4. "-1"是原始类型了，然后调用toNumber，返回-1

5. 与-2相乘，返回2

子表达式：

`~~!+[]`

不多说了，答案1。就是从右往左依次一元计算。

此刻它已经长这样了：2+1， 好，我不多说了。

继续看表达式：

`!(~+[])，~+[]=-1`

这个根据上面已经知道了，那!-1是什么呢？这里要说一下这个感叹号，它是逻辑取非的意思，会把表达式转化为布尔类型，转化规则和js的Truthy和Falsy原则是一样的，后面跟数字的，除0以外都为false，后面跟字符串的，除空串以外都为false。这里的!-1当然就是false了。

接下来这个表达式3：false+{}有点关键

一个布尔加一个对象，那这个{}应该先转化为原始类型，流程如下：

1. 调用toPrimitive，发现是object类型

2. 调用valueOf，返回自身{}，

3. 不是原始类型，调用toString，返回

4. [objectObject]

5. false与[objectObject]相加，false先转化为字符串"false"

相加得结果false[objectObject] 此时它是这样的：false[objectObject][3]，因为这个[]可以取字符串的子字符，像charAt一样，所以得到了结果"s"

经过上面艰难的流程，我们拿到了字符"s"，也就是那张图的左半边，剩下的那个"b"，相同的原理可以搞出来，我这里就不一一演示了，留给你练练吧~

回顾一下这个过程其实也不复杂，只是有一些需要重复劳动的，只要你掌握了运算的优先级，能把大串分解成一个个小串，然后运用类型转化的知识挨个处理就搞定了。怎么样，看到这里你还觉得神奇吗？

同样的，中文字符也是由这样组成的，跟英文同样的道理。
# 操作符也会影响数据的类型转换

1. 当+号作为一元操作符操作单操作数的时候，他就会将这个数转换为数字类型

2. 当+号作为二元操作符时，如果两个操作数中存在一个字符类型的话，那么另外一个操作数也会无条件地转换为字符串

3. 当+号作为二元操作符时，如果两个操作数一个都不是字符串的话，两个操作数会隐式转换成数字类型(如果无法成功转换成数字，则变成NaN，再往下操作)，再进行加法算数操作

4. 当算数运算的操作符是+号以外的其他操作数时，两个操作数都会转成数字类型进行数字运算。

# 引用对象如何转换为简单值

1. 一个复杂对象在转为基础类型的时候会调用ToPrimitive(hint)方法来指定其目标类型

2. 如果传入的hint值为number,那么就先调用对象的valueOf()方法，调用完valueOf()方法后，如果返回的是原始值，则结束ToPrimitive操作

3. 如果返回的不是原始值，则继续调用对象的toString()方法，调用完toString()方法之后如果返回的是一个原始值，则结束ToPrimitive操作

4. 如果返回的还是复杂值，则抛出异常。如果传入的hint值为string，则先调用toString()方法，再调用valueOf()方法，其余的过程一样。

# 那么复杂对象是以什么标准来判断ToPrimitive(hint)操作传入的hint值到底是number还是string呢？

1. 如果运行环境非常明确的需要将一个复杂对象转换为数字则传入number如 Number(value) 和 +value 则传入number

2. 如果运行环境非常明确的需要将一个复杂对象转换为字符串则传入string如String(value) 和 alert(value) 则传入string

3. 如果是用+号连接两个操作数，操作数在确定确定其中只要有一个为字符串的时候另外一个操作数会转为字符串，ToPrimitive()会传入string，但是如果两个操作数都不能确定是字符串的时候则默认传入number(Date对象是一个例外，它会默认传入string)进行数据类型转换。